{% comment %}
  Product Nutrition Facts Section
  Displays nutrition facts from custom.nutrition_facts metafield
  Always visible - no tabs for better conversions
{% endcomment %}

<section class="product-nutrition-facts">
  <div class="product-nutrition-facts__container">
    {% if section.settings.title != blank %}
      <h2 class="product-nutrition-facts__title">{{ section.settings.title }}</h2>
    {% endif %}
    
    {% assign nutrition_data = product.metafields.custom.nutrition_facts %}
    <div class="nutrition-facts-card">
      <div class="nutrition-facts-card__header">
        <h3 class="nutrition-facts-card__heading">Nutrition Facts</h3>
        {% assign serving_size = product.metafields.custom.serving_size | default: section.settings.serving_size %}
        {% if serving_size != blank %}
          <p class="nutrition-facts-card__serving">Serving Size: {{ serving_size }}</p>
        {% endif %}
      </div>
      
      {% if nutrition_data != blank %}
        {% comment %} Check if it's a list metafield (array) {% endcomment %}
        {% if nutrition_data.first %}
          {% comment %} It's a list metafield - render directly {% endcomment %}
          <ul class="nutrition-facts-card__list" id="nutrition-facts-list">
            {% for item in nutrition_data %}
              {% assign item_string = item | string %}
              {% assign item_parts = item_string | split: ':' %}
              {% if item_parts.size > 1 %}
                <li class="nutrition-facts-card__item">
                  <span class="nutrition-facts-card__label">{{ item_parts.first | strip }}</span>
                  <span class="nutrition-facts-card__value">{{ item_parts.last | strip }}</span>
                </li>
              {% else %}
                <li class="nutrition-facts-card__item">
                  <span class="nutrition-facts-card__label">{{ item_string | strip }}</span>
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        {% else %}
          {% comment %} It's a JSON string - parse with JavaScript {% endcomment %}
          {% assign nutrition_string = nutrition_data | string %}
          {% assign has_brackets = false %}
          {% if nutrition_string contains '[' %}
            {% assign has_brackets = true %}
          {% endif %}
          {% if has_brackets %}
            <ul class="nutrition-facts-card__list" id="nutrition-facts-list" data-nutrition-data="{{ nutrition_string | escape }}">
              <li class="nutrition-facts-card__item nutrition-facts-card__loading">
                <span class="nutrition-facts-card__label">Loading nutrition facts...</span>
              </li>
            </ul>
          {% else %}
            {% comment %} Plain text - try to split by newlines or commas {% endcomment %}
            <ul class="nutrition-facts-card__list" id="nutrition-facts-list">
              {% assign items = nutrition_string | split: '\n' %}
              {% if items.size == 1 %}
                {% assign items = nutrition_string | split: ',' %}
              {% endif %}
              {% for item in items %}
                {% assign item_string = item | string | strip %}
                {% if item_string != blank %}
                  {% assign item_parts = item_string | split: ':' %}
                  {% if item_parts.size > 1 %}
                    <li class="nutrition-facts-card__item">
                      <span class="nutrition-facts-card__label">{{ item_parts.first | strip }}</span>
                      <span class="nutrition-facts-card__value">{{ item_parts.last | strip }}</span>
                    </li>
                  {% else %}
                    <li class="nutrition-facts-card__item">
                      <span class="nutrition-facts-card__label">{{ item_string }}</span>
                    </li>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </ul>
          {% endif %}
        {% endif %}
      {% else %}
        <ul class="nutrition-facts-card__list" id="nutrition-facts-list">
          <li class="nutrition-facts-card__item">
            <span class="nutrition-facts-card__label" style="color: rgba(26, 26, 26, 0.5); font-style: italic;">
              No nutrition facts available. Please add data in product metafields (custom.nutrition_facts).
            </span>
          </li>
        </ul>
      {% endif %}
    </div>
  </div>
</section>

{% stylesheet %}
  .product-nutrition-facts {
    width: 100%;
    padding: 60px 40px;
    background: var(--bg);
    box-sizing: border-box;
  }

  .product-nutrition-facts__container {
    max-width: 900px;
    margin: 0 auto;
  }

  .product-nutrition-facts__title {
    text-align: center;
    font-family: var(--font-heading);
    font-size: 32px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 40px;
    letter-spacing: -0.02em;
    line-height: 1.2;
  }

  .nutrition-facts-card {
    background: var(--white);
    padding: 40px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  }

  .nutrition-facts-card__header {
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
  }

  .nutrition-facts-card__heading {
    font-family: var(--font-heading);
    font-size: 24px;
    color: var(--forest-green);
    margin-bottom: 8px;
    font-weight: 600;
  }

  .nutrition-facts-card__serving {
    font-size: 14px;
    color: rgba(26, 26, 26, 0.6);
    margin: 0;
    font-weight: 300;
  }

  .nutrition-facts-card__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nutrition-facts-card__item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 0;
    border-bottom: 1px solid rgba(26, 26, 26, 0.08);
    transition: background 0.2s ease;
  }

  .nutrition-facts-card__item:hover {
    background: rgba(74, 124, 44, 0.02);
    margin: 0 -12px;
    padding-left: 12px;
    padding-right: 12px;
    border-radius: 6px;
  }

  .nutrition-facts-card__item:last-child {
    border-bottom: none;
  }

  .nutrition-facts-card__loading {
    opacity: 0.6;
    font-style: italic;
  }

  .nutrition-facts-card__label {
    font-weight: 500;
    color: var(--text);
    font-size: 15px;
    flex: 1;
  }

  .nutrition-facts-card__value {
    font-weight: 700;
    color: var(--forest-green);
    font-size: 15px;
    margin-left: 20px;
    font-family: var(--font-heading);
  }

  @media (max-width: 768px) {
    .product-nutrition-facts {
      padding: 40px 20px;
    }

    .product-nutrition-facts__title {
      font-size: 28px;
      margin-bottom: 32px;
    }

    .nutrition-facts-card {
      padding: 28px 20px;
    }

    .nutrition-facts-card__heading {
      font-size: 20px;
    }
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    'use strict';
    
    function parseNutritionFacts() {
      const nutritionList = document.getElementById('nutrition-facts-list');
      if (!nutritionList) return;
      
      const nutritionData = nutritionList.getAttribute('data-nutrition-data');
      if (!nutritionData || nutritionData.trim() === '') return;
      
      try {
        // Unescape HTML entities
        let dataString = nutritionData
          .replace(/&quot;/g, '"')
          .replace(/&#39;/g, "'")
          .replace(/&amp;/g, '&')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .trim();
        
        // Try JSON parse first
        let nutritionArray;
        try {
          nutritionArray = JSON.parse(dataString);
        } catch (jsonError) {
          // If JSON parse fails, try regex extraction
          const match = dataString.match(/\[(.*?)\]/);
          if (match && match[1]) {
            const items = match[1].split(',').map(function(item) {
              return item.trim().replace(/^["']+|["']+$/g, '');
            });
            nutritionArray = items;
          } else {
            throw new Error('Could not parse');
          }
        }
        
        if (Array.isArray(nutritionArray) && nutritionArray.length > 0) {
          const fragment = document.createDocumentFragment();
          
          nutritionArray.forEach(function(item) {
            if (typeof item === 'string' && item.trim() !== '') {
              const colonIndex = item.indexOf(':');
              let label = colonIndex > -1 ? item.substring(0, colonIndex).trim() : item.trim();
              let value = colonIndex > -1 ? item.substring(colonIndex + 1).trim() : '';
              
              const listItem = document.createElement('li');
              listItem.className = 'nutrition-facts-card__item';
              
              const labelSpan = document.createElement('span');
              labelSpan.className = 'nutrition-facts-card__label';
              labelSpan.textContent = label;
              listItem.appendChild(labelSpan);
              
              if (value) {
                const valueSpan = document.createElement('span');
                valueSpan.className = 'nutrition-facts-card__value';
                valueSpan.textContent = value;
                listItem.appendChild(valueSpan);
              }
              
              fragment.appendChild(listItem);
            }
          });
          
          nutritionList.innerHTML = '';
          nutritionList.appendChild(fragment);
        }
      } catch (e) {
        console.error('Error parsing nutrition facts:', e);
        nutritionList.innerHTML = '<li class="nutrition-facts-card__item"><span class="nutrition-facts-card__label" style="color: rgba(26, 26, 26, 0.5); font-style: italic;">Unable to parse nutrition data. Please check the metafield format.</span></li>';
      }
    }
    
    // Run immediately if DOM is ready, otherwise wait
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', parseNutritionFacts);
    } else {
      // Use setTimeout to ensure DOM is fully rendered
      setTimeout(parseNutritionFacts, 0);
    }
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Product Nutrition Facts",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Nutrition Facts"
    },
    {
      "type": "text",
      "id": "serving_size",
      "label": "Serving Size",
      "default": "1 scoop (10g)"
    }
  ],
  "presets": [
    {
      "name": "Product Nutrition Facts"
    }
  ]
}
{% endschema %}
