{% comment %}
  Product Nutrition Facts Section
  Displays nutrition facts from custom.nutrition_facts metafield
  Always visible - no tabs for better conversions
{% endcomment %}

<section class="product-nutrition-facts">
  <div class="product-nutrition-facts__container">
    {% if section.settings.title != blank %}
      <h2 class="product-nutrition-facts__title">{{ section.settings.title }}</h2>
    {% endif %}
    
    {% assign nutrition_data = product.metafields.custom.nutrition_facts %}
    <div class="nutrition-facts-card">
      <div class="nutrition-facts-card__header">
        <h3 class="nutrition-facts-card__heading">Nutrition Facts</h3>
        {% assign serving_size = product.metafields.custom.serving_size | default: section.settings.serving_size %}
        {% if serving_size != blank %}
          <p class="nutrition-facts-card__serving">Serving Size: {{ serving_size }}</p>
        {% endif %}
      </div>
      
      {% if nutrition_data != blank %}
        {% comment %} Check if it's a list metafield (array) {% endcomment %}
        {% if nutrition_data.first %}
          {% comment %} It's a list metafield - render directly {% endcomment %}
          <ul class="nutrition-facts-card__list">
            {% for item in nutrition_data %}
              {% assign item_string = item | string %}
              {% assign item_parts = item_string | split: ':' %}
              {% if item_parts.size > 1 %}
                <li class="nutrition-facts-card__item">
                  <span class="nutrition-facts-card__label">{{ item_parts.first | strip }}</span>
                  <span class="nutrition-facts-card__value">{{ item_parts.last | strip }}</span>
                </li>
              {% else %}
                <li class="nutrition-facts-card__item">
                  <span class="nutrition-facts-card__label">{{ item_string | strip }}</span>
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        {% else %}
          {% comment %} It's a string - check if it's JSON {% endcomment %}
          {% assign nutrition_string = nutrition_data | string %}
          {% if nutrition_string contains '[' and nutrition_string contains ']' %}
            {% comment %} It's a JSON string - parse with JavaScript {% endcomment %}
            <ul class="nutrition-facts-card__list" id="nutrition-facts-list-{{ section.id }}"></ul>
            <script>
              (function() {
                var listId = 'nutrition-facts-list-{{ section.id }}';
                var nutritionData = {{ nutrition_string | json }};
                
                function renderNutritionFacts() {
                  var listEl = document.getElementById(listId);
                  if (!listEl) {
                    setTimeout(renderNutritionFacts, 50);
                    return;
                  }
                  
                  try {
                    var items = [];
                    
                    // If it's already an array, use it directly
                    if (Array.isArray(nutritionData)) {
                      items = nutritionData;
                    }
                    // If it's a string, try to parse it
                    else if (typeof nutritionData === 'string') {
                      try {
                        items = JSON.parse(nutritionData);
                      } catch(e) {
                        // Try regex extraction
                        var match = nutritionData.match(/\[(.*?)\]/);
                        if (match && match[1]) {
                          items = match[1].split(',').map(function(item) {
                            return item.trim().replace(/^["']+|["']+$/g, '');
                          });
                        }
                      }
                    }
                    
                    if (Array.isArray(items) && items.length > 0) {
                      var html = '';
                      items.forEach(function(item) {
                        if (item && item.toString().trim() !== '') {
                          var itemStr = item.toString().trim();
                          var colonIndex = itemStr.indexOf(':');
                          var label = colonIndex > -1 ? itemStr.substring(0, colonIndex).trim() : itemStr;
                          var value = colonIndex > -1 ? itemStr.substring(colonIndex + 1).trim() : '';
                          
                          html += '<li class="nutrition-facts-card__item">';
                          html += '<span class="nutrition-facts-card__label">' + label + '</span>';
                          if (value) {
                            html += '<span class="nutrition-facts-card__value">' + value + '</span>';
                          }
                          html += '</li>';
                        }
                      });
                      listEl.innerHTML = html;
                    } else {
                      listEl.innerHTML = '<li class="nutrition-facts-card__item"><span class="nutrition-facts-card__label" style="color: rgba(26, 26, 26, 0.5); font-style: italic;">No nutrition facts found</span></li>';
                    }
                  } catch(e) {
                    listEl.innerHTML = '<li class="nutrition-facts-card__item"><span class="nutrition-facts-card__label" style="color: rgba(26, 26, 26, 0.5); font-style: italic;">Error loading nutrition facts</span></li>';
                  }
                }
                
                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', renderNutritionFacts);
                } else {
                  renderNutritionFacts();
                }
              })();
            </script>
          {% else %}
            {% comment %} Plain text - try to split by newlines or commas {% endcomment %}
            <ul class="nutrition-facts-card__list">
              {% assign items = nutrition_string | split: '\n' %}
              {% if items.size == 1 %}
                {% assign items = nutrition_string | split: ',' %}
              {% endif %}
              {% for item in items %}
                {% assign item_string = item | string | strip %}
                {% if item_string != blank %}
                  {% assign item_parts = item_string | split: ':' %}
                  {% if item_parts.size > 1 %}
                    <li class="nutrition-facts-card__item">
                      <span class="nutrition-facts-card__label">{{ item_parts.first | strip }}</span>
                      <span class="nutrition-facts-card__value">{{ item_parts.last | strip }}</span>
                    </li>
                  {% else %}
                    <li class="nutrition-facts-card__item">
                      <span class="nutrition-facts-card__label">{{ item_string }}</span>
                    </li>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </ul>
          {% endif %}
        {% endif %}
      {% else %}
        <ul class="nutrition-facts-card__list">
          <li class="nutrition-facts-card__item">
            <span class="nutrition-facts-card__label" style="color: rgba(26, 26, 26, 0.5); font-style: italic;">
              No nutrition facts available. Please add data in product metafields (custom.nutrition_facts).
            </span>
          </li>
        </ul>
      {% endif %}
    </div>
  </div>
</section>

{% stylesheet %}
  .product-nutrition-facts {
    width: 100%;
    padding: 60px 40px;
    background: var(--bg);
    box-sizing: border-box;
  }

  .product-nutrition-facts__container {
    max-width: 900px;
    margin: 0 auto;
  }

  .product-nutrition-facts__title {
    text-align: center;
    font-family: var(--font-heading);
    font-size: 32px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 40px;
    letter-spacing: -0.02em;
    line-height: 1.2;
  }

  .nutrition-facts-card {
    background: var(--white);
    padding: 40px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  }

  .nutrition-facts-card__header {
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
  }

  .nutrition-facts-card__heading {
    font-family: var(--font-heading);
    font-size: 24px;
    color: var(--forest-green);
    margin-bottom: 8px;
    font-weight: 600;
  }

  .nutrition-facts-card__serving {
    font-size: 14px;
    color: rgba(26, 26, 26, 0.6);
    margin: 0;
    font-weight: 300;
  }

  .nutrition-facts-card__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nutrition-facts-card__item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 0;
    border-bottom: 1px solid rgba(26, 26, 26, 0.08);
    transition: background 0.2s ease;
  }

  .nutrition-facts-card__item:hover {
    background: rgba(74, 124, 44, 0.02);
    margin: 0 -12px;
    padding-left: 12px;
    padding-right: 12px;
    border-radius: 6px;
  }

  .nutrition-facts-card__item:last-child {
    border-bottom: none;
  }

  .nutrition-facts-card__label {
    font-weight: 500;
    color: var(--text);
    font-size: 15px;
    flex: 1;
  }

  .nutrition-facts-card__value {
    font-weight: 700;
    color: var(--forest-green);
    font-size: 15px;
    margin-left: 20px;
    font-family: var(--font-heading);
  }

  @media (max-width: 768px) {
    .product-nutrition-facts {
      padding: 40px 20px;
    }

    .product-nutrition-facts__title {
      font-size: 28px;
      margin-bottom: 32px;
    }

    .nutrition-facts-card {
      padding: 28px 20px;
    }

    .nutrition-facts-card__heading {
      font-size: 20px;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Product Nutrition Facts",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Nutrition Facts"
    },
    {
      "type": "text",
      "id": "serving_size",
      "label": "Serving Size",
      "default": "1 scoop (10g)"
    }
  ],
  "presets": [
    {
      "name": "Product Nutrition Facts"
    }
  ]
}
{% endschema %}
