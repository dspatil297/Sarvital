{% assign selected_collection = null %}
{% if section.settings.collection != blank %}
  {% assign selected_collection = collections[section.settings.collection] %}
{% elsif product and product.collections.size > 0 %}
  {% assign selected_collection = product.collections.first %}
{% endif %}

<section class="product-grid-section fade-in-up {% if section.settings.layout == 'carousel' %}product-grid-section--carousel{% endif %}" style="animation-delay: 0.8s;" data-layout="{{ section.settings.layout }}" data-auto-scroll="{% if section.settings.carousel_auto_scroll %}true{% else %}false{% endif %}" data-auto-scroll-interval="{{ section.settings.carousel_auto_scroll_interval | default: 4 }}">
  <div class="product-grid-section__container">
    {% if section.settings.title != blank %}
      <h2 class="product-grid-section__title">{{ section.settings.title }}</h2>
    {% endif %}
    
    {% if section.settings.description != blank %}
      <p class="product-grid-section__description">{{ section.settings.description }}</p>
    {% endif %}
    
    {% if selected_collection != null and selected_collection.products.size > 0 %}
      {% if section.settings.layout == 'carousel' %}
        {% comment %} Desktop: grid of cards (hidden on mobile) {% endcomment %}
        <div class="product-grid-section__grid product-grid-section__grid--desktop">
          {% assign products_shown = 0 %}
          {% for product_item in selected_collection.products %}
            {% if products_shown >= section.settings.products_to_show %}{% break %}{% endif %}
            {% unless product and product_item.id == product.id %}
              {% assign products_shown = products_shown | plus: 1 %}
              {% render 'product-card', product: product_item %}
              {% render 'quick-view', product: product_item %}
            {% endunless %}
          {% endfor %}
        </div>
        {% comment %} Mobile: carousel only (hidden on desktop) {% endcomment %}
        <div class="product-grid-section__carousel-wrap product-grid-section__carousel-wrap--mobile" id="product-carousel-{{ section.id }}" data-carousel-wrap data-auto-scroll="{% if section.settings.carousel_auto_scroll %}true{% else %}false{% endif %}" data-scroll-interval="{{ section.settings.carousel_auto_scroll_interval | default: 6 }}">
          <button type="button" class="product-grid-section__carousel-arrow product-grid-section__carousel-arrow--prev" data-carousel-prev aria-label="Previous products">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button type="button" class="product-grid-section__carousel-arrow product-grid-section__carousel-arrow--next" data-carousel-next aria-label="Next products">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="product-grid-section__carousel-scroll" data-carousel-scroll tabindex="0">
            <div class="product-grid-section__carousel-track" data-carousel-track>
              {% for loop_index in (1..2) %}
                {% assign products_shown = 0 %}
                {% for product_item in selected_collection.products %}
                  {% if products_shown >= section.settings.products_to_show %}{% break %}{% endif %}
                  {% unless product and product_item.id == product.id %}
                    {% assign products_shown = products_shown | plus: 1 %}
                    <div class="product-grid-section__carousel-slide">
                      {% render 'product-card', product: product_item %}
                      {% render 'quick-view', product: product_item %}
                    </div>
                  {% endunless %}
                {% endfor %}
              {% endfor %}
            </div>
          </div>
        </div>
      {% else %}
        <div class="product-grid-section__grid">
          {% assign products_shown = 0 %}
          {% for product_item in selected_collection.products %}
            {% if products_shown >= section.settings.products_to_show %}{% break %}{% endif %}
            {% unless product and product_item.id == product.id %}
              {% assign products_shown = products_shown | plus: 1 %}
              {% render 'product-card', product: product_item %}
              {% render 'quick-view', product: product_item %}
            {% endunless %}
          {% endfor %}
        </div>
      {% endif %}
          
      {% if section.settings.show_view_all %}
        <div class="product-grid-section__footer">
          <a href="{{ selected_collection.url }}" class="btn btn-outline btn-large">
            {{ section.settings.view_all_text | default: 'View All Products' }}
          </a>
        </div>
      {% endif %}
    {% elsif selected_collection != null %}
      <div class="product-grid-section__empty">
        <p>No products found in this collection.</p>
      </div>
    {% else %}
      <div class="product-grid-section__empty">
        <p>Please select a collection to display products.</p>
      </div>
    {% endif %}
  </div>
</section>

{% stylesheet %}
  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in-up {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
  }

  @media (prefers-reduced-motion: reduce) {
    .product-grid-section.fade-in-up {
      opacity: 1;
      animation: none;
    }
  }

  .product-grid-section {
    width: 100%;
    max-width: 100%;
    padding: var(--spacing-4xl) var(--spacing-lg);
    background: linear-gradient(180deg, var(--white) 0%, rgba(250, 250, 250, 0.3) 50%, var(--white) 100%);
    position: relative;
    overflow: hidden;
    box-sizing: border-box;
  }

  .product-grid-section__container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .product-grid-section__title {
    text-align: center;
    font-family: var(--font-heading);
    font-size: clamp(28px, 4vw, 42px);
    font-weight: 700;
    color: var(--forest-green);
    margin-bottom: var(--spacing-sm);
    margin-top: 0;
    letter-spacing: -0.02em;
    position: relative;
    display: inline-block;
    width: 100%;
    line-height: 1.3;
    padding: 0;
  }


  .product-grid-section__description {
    text-align: center;
    font-size: var(--body-large);
    font-weight: 400;
    color: rgba(26, 26, 26, 0.7);
    margin-top: var(--spacing-xs);
    margin-bottom: var(--spacing-2xl);
    max-width: 650px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.7;
  }

  .product-grid-section__grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
  }

  @media (min-width: 1400px) {
    .product-grid-section__grid {
      gap: var(--spacing-2xl);
    }
  }

  .product-grid-section__footer {
    text-align: center;
    margin-top: var(--spacing-xl);
  }

  .product-grid-section__footer .btn {
    background: linear-gradient(135deg, var(--forest-green) 0%, var(--sage-green) 100%);
    color: var(--white);
    border: none;
    padding: var(--spacing-md) var(--spacing-3xl);
    font-weight: 600;
    font-size: var(--body-large);
    box-shadow: 0 8px 25px rgba(74, 124, 44, 0.3);
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .product-grid-section__footer .btn:hover {
    color: var(--white);
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(74, 124, 44, 0.4);
    background: linear-gradient(135deg, var(--sage-green) 0%, var(--forest-green) 100%);
  }

  .product-grid-section__empty {
    text-align: center;
    padding: var(--spacing-4xl) var(--spacing-lg);
    color: #999;
  }

  @media (max-width: 1024px) {
    .product-grid-section__grid {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-lg);
    }
  }

  @media (max-width: 768px) {
    .product-grid-section {
      padding: var(--spacing-3xl) var(--spacing-md);
    }

    .product-grid-section__grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
    }
  }

  @media (max-width: 480px) {
    .product-grid-section__grid {
      grid-template-columns: 1fr;
    }
  }

  /* When layout is Carousel: grid on desktop (769px+), carousel on mobile */
  .product-grid-section__grid--desktop {
    display: none;
  }

  .product-grid-section__carousel-wrap--mobile {
    display: block;
  }

  @media (min-width: 769px) {
    .product-grid-section__grid--desktop {
      display: grid;
    }

    .product-grid-section__carousel-wrap--mobile {
      display: none !important;
    }
  }

  /* Carousel layout - native scroll (mobile only) */
  .product-grid-section__carousel-wrap {
    position: relative;
    margin-bottom: var(--spacing-xl);
    padding: 0 var(--spacing-lg);
    overflow: hidden;
    box-sizing: border-box;
  }

  .product-grid-section__carousel-scroll {
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    scroll-behavior: smooth;
    scroll-snap-type: x mandatory;
    margin: 0 calc(-1 * var(--spacing-lg));
    padding: 0 var(--spacing-lg);
    box-sizing: border-box;
    min-height: 420px;
  }

  @media (min-width: 769px) {
    .product-grid-section__carousel-scroll {
      min-height: 0;
    }
  }

  .product-grid-section__carousel-scroll::-webkit-scrollbar {
    display: none;
  }

  .product-grid-section__carousel-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid rgba(74, 124, 44, 0.2);
    background: var(--white);
    color: var(--forest-green);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    -webkit-tap-highlight-color: transparent;
  }

  .product-grid-section__carousel-arrow:hover {
    background: linear-gradient(135deg, var(--forest-green) 0%, var(--sage-green) 100%);
    color: var(--white);
    border-color: transparent;
    box-shadow: 0 6px 20px rgba(74, 124, 44, 0.35);
  }

  .product-grid-section__carousel-arrow--prev {
    left: 0;
  }

  .product-grid-section__carousel-arrow--next {
    right: 0;
  }

  @media (max-width: 768px) {
    .product-grid-section__carousel-arrow {
      width: 40px;
      height: 40px;
    }

    .product-grid-section__carousel-arrow--prev {
      left: -4px;
    }

    .product-grid-section__carousel-arrow--next {
      right: -4px;
    }
  }

  .product-grid-section__carousel-track {
    display: flex;
    align-items: stretch;
    gap: 28px;
    width: max-content;
    min-width: 100%;
    box-sizing: border-box;
  }

  .product-grid-section__carousel-slide {
    flex: 0 0 280px;
    width: 280px;
    min-width: 280px;
    display: flex;
    align-items: stretch;
    overflow: hidden;
    box-sizing: border-box;
    scroll-snap-align: start;
    scroll-snap-stop: always;
  }

  .product-grid-section__carousel-slide .product-card {
    width: 100%;
    height: 100%;
    min-height: 0;
    box-sizing: border-box;
    overflow: hidden;
  }

  .product-grid-section__carousel-slide .product-card__link {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .product-grid-section__carousel-slide .product-card__info {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .product-grid-section__carousel-slide .product-card__form {
    margin-top: auto;
  }

  .product-grid-section__carousel-slide .product-card:hover {
    transform: none;
  }

  @media (min-width: 769px) {
    .product-grid-section__carousel-slide {
      flex: 0 0 300px;
      width: 300px;
      min-width: 300px;
    }
  }

  @media (min-width: 1025px) {
    .product-grid-section__carousel-slide {
      flex: 0 0 320px;
      width: 320px;
      min-width: 320px;
    }
  }
{% endstylesheet %}

<script>
  (function() {
    function initCarousels() {
      var wraps = document.querySelectorAll('[data-carousel-wrap]');
      wraps.forEach(function(wrap) {
        if (wrap.dataset.carouselInited === 'yes') return;
        var scrollEl = wrap.querySelector('[data-carousel-scroll]');
        var track = wrap.querySelector('[data-carousel-track]');
        if (!scrollEl || !track) return;
        wrap.dataset.carouselInited = 'yes';

        var autoScroll = wrap.dataset.autoScroll === 'true';
        var intervalSec = parseInt(wrap.dataset.scrollInterval, 10) || 6;
        var slides = track.querySelectorAll('.product-grid-section__carousel-slide');
        var totalSlides = slides.length;
        if (totalSlides < 2) return;

        var slideWidthPx = 280;
        var gapPx = 28;
        var slideStep = slideWidthPx + gapPx;
        var half = Math.floor(totalSlides / 2);
        var setWidth = half * slideStep;
        var autoInterval = null;
        var cardIntervalMs = 1500;

        function snapToStep(pos) {
          return Math.round(pos / slideStep) * slideStep;
        }

        function slideToNext() {
          var current = scrollEl.scrollLeft;
          var target = snapToStep(current) + slideStep;
          if (target >= setWidth) {
            scrollEl.style.scrollBehavior = 'auto';
            scrollEl.scrollLeft = 0;
            scrollEl.style.scrollBehavior = 'smooth';
            scrollEl.scrollLeft = target - setWidth;
          } else {
            scrollEl.scrollLeft = target;
          }
        }

        function startAutoScroll() {
          if (!autoScroll || autoInterval) return;
          autoInterval = setInterval(slideToNext, cardIntervalMs);
        }

        function stopAutoScroll() {
          if (autoInterval) {
            clearInterval(autoInterval);
            autoInterval = null;
          }
        }

        var prevBtn = wrap.querySelector('[data-carousel-prev]');
        var nextBtn = wrap.querySelector('[data-carousel-next]');
        if (prevBtn) {
          prevBtn.addEventListener('click', function() {
            stopAutoScroll();
            var cur = scrollEl.scrollLeft;
            var targetPrev = snapToStep(cur) - slideStep;
            if (targetPrev < 0) {
              scrollEl.style.scrollBehavior = 'auto';
              scrollEl.scrollLeft = setWidth - slideStep;
              scrollEl.style.scrollBehavior = 'smooth';
            } else {
              scrollEl.scrollLeft = targetPrev;
            }
            if (autoScroll) setTimeout(startAutoScroll, 3000);
          });
        }
        if (nextBtn) {
          nextBtn.addEventListener('click', function() {
            stopAutoScroll();
            var cur = scrollEl.scrollLeft;
            var next = snapToStep(cur) + slideStep;
            if (next >= setWidth) {
              scrollEl.style.scrollBehavior = 'auto';
              scrollEl.scrollLeft = 0;
              scrollEl.style.scrollBehavior = 'smooth';
              scrollEl.scrollLeft = next - setWidth;
            } else {
              scrollEl.scrollLeft = next;
            }
            if (autoScroll) setTimeout(startAutoScroll, 3000);
          });
        }

        wrap.addEventListener('mouseenter', stopAutoScroll);
        wrap.addEventListener('mouseleave', function() {
          if (autoScroll) startAutoScroll();
        });

        if (autoScroll) {
          setTimeout(startAutoScroll, 300);
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarousels);
    } else {
      initCarousels();
    }
    setTimeout(initCarousels, 500);
    setTimeout(initCarousels, 1500);
  })();
</script>

{% schema %}
{
  "name": "Product Grid",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Our Premium Powders"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Discover our range of premium fruit and vegetable powders, carefully crafted for your wellness journey."
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "carousel", "label": "Carousel" }
      ],
      "default": "carousel"
    },
    {
      "type": "checkbox",
      "id": "carousel_auto_scroll",
      "label": "Auto scroll carousel",
      "info": "When layout is Carousel, scroll automatically in a loop",
      "default": true
    },
    {
      "type": "range",
      "id": "carousel_auto_scroll_interval",
      "label": "Auto scroll speed (seconds per loop)",
      "min": 3,
      "max": 15,
      "step": 1,
      "default": 6,
      "info": "Time to scroll through one full set of products"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Leave empty on product pages to automatically use the product's collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to Show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show View All Button",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View All Button Text",
      "default": "View All Products"
    }
  ],
  "presets": [
    {
      "name": "Product Grid"
    }
  ]
}
{% endschema %}
